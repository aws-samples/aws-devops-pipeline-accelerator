version: "0.2"
env:
  git-credential-helper: "yes"
  shell: bash
  
phases:
  install:
    commands:
      - yum install jq -y

  build:
    commands:
      - echo "Check The envType"
      - echo "${CODEBUILD_SRC_DIR}" #Base repo, IAC code
      - echo "${CODEBUILD_SRC_DIR_SourceOutput1}" #DBM repo, DBM code
      - "cd ${CODEBUILD_SRC_DIR_SourceOutput1}"
      - ls -lrt
      - |
        ENV_TYPE=$( jq -r '.envType' entrypoint/terraform-infrastructure.json )
        stage_required=$( jq -r '.build_stage_required' entrypoint/terraform-infrastructure.json )
        if [ $stage_required == "false" ]; then
          echo "skipping Test stage....."
          exit 0
        else
          terraform init
          echo "### FORMAT & VALIDATE #####"
          # terraform fmt -recursive
          # terraform validate
          # echo "#### TERRAFORM PLAN : Starting with the Terraform PLAN"
          # terraform plan -lock=false -out=tfplan
        fi
        
  post_build:
    commands:
      - echo "Display Last Changes"